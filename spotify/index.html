<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Authentication - DECK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Callback-specific styles only */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .callback-container {
            text-align: center;
            background: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 90%;
            color: var(--text-color);
        }

        .callback-container h1 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--spotify-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: var(--error-color);
            background: var(--error-background);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .success {
            color: var(--success-color);
            background: var(--success-background);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .hidden {
            display: none;
        }

        .logo {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div id="loading-state">
            <div class="logo">
                <i class="fab fa-spotify"></i>
            </div>
            <div class="spinner"></div>
            <h2>Completing Spotify Authentication...</h2>
        </div>

        <div id="error-state" class="hidden">
            <div class="logo">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Authentication Error</h2>
            <div id="error-message" class="error"></div>
            <p>You will be redirected back to the app shortly.</p>
        </div>

        <div id="success-state" class="hidden">
            <div class="logo">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Authentication Successful!</h2>
            <div id="success-message" class="success"></div>
        </div>
    </div>

    <script>
        // Spotify OAuth callback handler
        const CONFIG = {
            CLIENT_ID: '9801203f29414b42a749637524f1fc48',
            AUTH_BASE_URL: 'https://accounts.spotify.com',
            MAIN_APP_PATH: '/'
        };

        const elements = {
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            successState: document.getElementById('success-state'),
            errorMessage: document.getElementById('error-message'),
            successMessage: document.getElementById('success-message')
        };

        function showError(message) {
            elements.loadingState.classList.add('hidden');
            elements.errorState.classList.remove('hidden');
            elements.errorMessage.textContent = message;
        }

        function showSuccess(message) {
            elements.loadingState.classList.add('hidden');
            elements.successState.classList.remove('hidden');
            elements.successMessage.textContent = message;
        }

        async function handleCallback() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');

                if (error) {
                    throw new Error(`Spotify authorization error: ${error}`);
                }

                if (!code || !state) {
                    throw new Error('Missing required OAuth parameters');
                }

                // Verify state parameter for CSRF protection
                const storedState = localStorage.getItem('spotify_auth_state');

                if (state !== storedState) {
                    throw new Error('Invalid state parameter - possible security issue');
                }

                // Get code verifier for PKCE
                const codeVerifier = localStorage.getItem('spotify_code_verifier');
                if (!codeVerifier) {
                    throw new Error('Code verifier not found - authentication session expired');
                }

                // Exchange authorization code for access token
                const tokenResponse = await fetch(`${CONFIG.AUTH_BASE_URL}/api/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: window.location.href.split('?')[0], // Current callback URL
                        client_id: CONFIG.CLIENT_ID,
                        code_verifier: codeVerifier,
                    }),
                });

                const tokenData = await tokenResponse.json();

                if (!tokenResponse.ok) {
                    throw new Error(`Token exchange failed: ${tokenData.error_description || tokenData.error}`);
                }

                // Store tokens in localStorage
                localStorage.setItem('spotify_access_token', tokenData.access_token);
                if (tokenData.refresh_token) {
                    localStorage.setItem('spotify_refresh_token', tokenData.refresh_token);
                }
                localStorage.setItem('spotify_token_expires_at', Date.now() + (tokenData.expires_in * 1000));

                // Clean up OAuth state
                localStorage.removeItem('spotify_code_verifier');
                localStorage.removeItem('spotify_auth_state');

                // Get saved cards from before authentication
                const savedCards = localStorage.getItem('spotify_cards_before_auth');

                // Build redirect URL
                const redirectUrl = new URL(window.location.origin + CONFIG.MAIN_APP_PATH);

                if (savedCards) {
                    // Clean up saved cards
                    localStorage.removeItem('spotify_cards_before_auth');

                    // Add cards to URL for restoration
                    redirectUrl.searchParams.set('cards', savedCards);
                }

                // Add success flag
                redirectUrl.searchParams.set('spotify_auth', 'success');

                showSuccess('Redirecting back to your cards...');

                // Redirect after a short delay to show success message
                setTimeout(() => {
                    window.location.href = redirectUrl.toString();
                }, 1500);

            } catch (error) {
                console.error('OAuth callback error:', error);
                showError(error.message);

                // Clean up on error
                localStorage.removeItem('spotify_code_verifier');
                localStorage.removeItem('spotify_auth_state');
                localStorage.removeItem('spotify_cards_before_auth');

                // Redirect back to main app after showing error
                setTimeout(() => {
                    const errorUrl = new URL(window.location.origin + CONFIG.MAIN_APP_PATH);
                    errorUrl.searchParams.set('spotify_auth', 'error');
                    errorUrl.searchParams.set('error_message', encodeURIComponent(error.message));
                    window.location.href = errorUrl.toString();
                }, 3000);
            }
        }

        // Start callback processing when page loads
        window.addEventListener('load', handleCallback);

        // Fallback: redirect to main app if something goes very wrong
        setTimeout(() => {
            if (window.location.pathname.includes('spotify')) {
                console.warn('Fallback redirect triggered');
                window.location.href = window.location.origin + CONFIG.MAIN_APP_PATH;
            }
        }, 15000); // 15 second fallback
    </script>
</body>
</html>
